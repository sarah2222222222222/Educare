<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EDUCARE - Publish Course</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f4f7fc;
      }

      .floating {
        animation: float 2s ease-in-out infinite;
      }

      @keyframes float {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body class="min-h-screen text-gray-800">
    <!-- Header -->
    <header class="bg-white shadow-md py-4 px-6">
      <div class="flex items-center justify-between max-w-6xl mx-auto">
        <div class="flex items-center gap-4">
          <button id="homeIconBtn" class="text-gray-500 hover:text-blue-600">
            <i class="fas fa-home fa-lg"></i>
          </button>
          <img
            class="w-10 h-10"
            src="../assets/Images/Untitled design (1).png"
            alt="Logo"
          />
          <span class="text-xl font-semibold text-blue-600">EDUCARE</span>
        </div>
        <div class="flex items-center gap-4">
          <button class="relative">
            <i
              class="fas fa-shopping-cart text-gray-500 hover:text-blue-600 fa-lg"
            ></i>
            <span
              class="absolute -top-2 -right-2 text-xs bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center"
              >0</span
            >
          </button>
          <div class="flex items-center gap-2">
            <img
              src="../assets/Images/AI women.jpg"
              alt="User Avatar"
              class="w-10 h-10 rounded-full border"
            />
            <div>
              <p class="text-sm font-semibold">Sarah</p>
              <p class="text-xs text-gray-500">Othman</p>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Hero Banner -->
    <section class="bg-gradient-to-r from-blue-50 to-blue-100 py-12">
      <div class="max-w-4xl mx-auto text-center">
        <h2 class="text-4xl font-bold text-blue-700">
          Create & Share Knowledge
        </h2>
        <p class="mt-3 text-gray-600 text-lg">
          Design and publish your course on EDUCARE
        </p>
      </div>
    </section>

    <!-- Main Form Section -->
    <main class="max-w-4xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
      <h1 class="text-2xl font-semibold mb-6 text-gray-800">
        Publish a New Course
      </h1>
      <form
        id="publishCourseForm"
        class="bg-white p-10 rounded-xl shadow-lg border border-gray-200 space-y-6"
      >
        <h3 class="text-xl font-semibold text-blue-600 mb-4">Course Details</h3>

        <!-- Title -->
        <div>
          <label for="courseTitle" class="block text-sm font-medium mb-1"
            >Course Title</label
          >
          <input
            type="text"
            id="courseTitle"
            name="courseTitle"
            placeholder="Enter course title"
            required
            class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-400 focus:outline-none"
          />
        </div>

        <!-- Description -->
        <div>
          <label for="courseDescription" class="block text-sm font-medium mb-1"
            >Course Description</label
          >
          <textarea
            id="courseDescription"
            name="courseDescription"
            rows="4"
            placeholder="Describe your course"
            required
            class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-400 focus:outline-none"
          ></textarea>
        </div>

        <!-- Price -->
        <div>
          <label for="coursePrice" class="block text-sm font-medium mb-1"
            >Price (LE)</label
          >
          <input
            type="number"
            id="coursePrice"
            name="coursePrice"
            placeholder="Enter course price"
            min="0"
            step="0.01"
            required
            class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-400 focus:outline-none"
          />
        </div>

        <!-- Class Selection -->
        <div>
          <label for="classId" class="block text-sm font-medium mb-1"
            >Select Class</label
          >
          <select
            id="classId"
            name="classId"
            required
            class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-400 focus:outline-none"
          >
            <option value="">-- Select Class --</option>
            <!-- Dynamic options will be added here from the database -->
          </select>
        </div>

        <!-- Image Upload -->
        <div>
          <label for="courseImage" class="block text-sm font-medium mb-1"
            >Course Image</label
          >
          <input
            type="file"
            id="courseImage"
            name="courseImage"
            accept="image/*"
            required
            class="block w-full text-sm text-gray-700 border border-gray-300 rounded-md cursor-pointer bg-gray-50 focus:outline-none"
          />
          <div id="imagePreviewContainer" class="mt-4 hidden">
            <img
              id="imagePreview"
              src=""
              alt="Preview"
              class="w-full h-48 object-cover rounded-md border border-gray-200"
            />
          </div>
        </div>

        <!-- Submit Button -->
        <button
          type="submit"
          class="w-full bg-blue-600 text-white py-3 rounded-md font-semibold hover:bg-blue-700 transition transform hover:-translate-y-1 shadow-md"
        >
          <i class="fas fa-upload mr-2"></i>Publish Course
        </button>
      </form>
    </main>

    <!-- Floating AI Chatbot Icon -->
    <div class="fixed bottom-4 right-4 floating">
      <a href="./chatbot.html">
        <img
          alt="AI Chatbot"
          class="w-16 h-16 rounded-full border-2 border-blue-500"
          src="../assets/Images/WhatsApp Image 2024-11-15 at 19.39.33_b2a01f1c.jpg"
        />
      </a>
    </div>

    <!-- Script Section -->
    <script>
      // JWT Decoding (for setting user info if needed)
      function decodeJwt(token) {
        const base64Url = token.split(".")[1];
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        const jsonPayload = decodeURIComponent(
          atob(base64)
            .split("")
            .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
            .join("")
        );
        return JSON.parse(jsonPayload);
      }

      const token = localStorage.getItem("token");
      if (!token) {
        alert("You must be logged in to access this page.");
      }

      // Fetch classes for the dropdown
      async function loadClasses() {
        try {
          const response = await fetch("http://localhost:3000/class", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const data = await response.json();
          const classes = data.data; // This is the array from the API response
          const classSelect = document.getElementById("classId");

          // Clear the existing options in the select dropdown
          classSelect.innerHTML =
            '<option value="">-- Select Class --</option>';

          // Add the class options dynamically
          classes.forEach((classItem) => {
            const option = document.createElement("option");
            option.value = classItem._id;
            // Displaying name and subject in the dropdown
            option.textContent = `${classItem.name} - ${classItem.subject}`;
            classSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading classes:", error);
        }
      }
      loadClasses();

      // Image preview
      document
        .getElementById("courseImage")
        .addEventListener("change", function () {
          const preview = document.getElementById("imagePreview");
          const container = document.getElementById("imagePreviewContainer");
          const file = this.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              preview.src = e.target.result;
              container.classList.remove("hidden");
            };
            reader.readAsDataURL(file);
          }
        });

      // Submit Handler
      const publishCourseForm = document.getElementById("publishCourseForm");
      publishCourseForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const title = e.target.courseTitle.value.trim();
        const description = e.target.courseDescription.value.trim();
        const price = parseFloat(e.target.coursePrice.value);
        const classId = e.target.classId.value;
        const imageFile = e.target.courseImage.files[0];

        if (
          !title ||
          !description ||
          isNaN(price) ||
          price < 0 ||
          !classId ||
          !imageFile
        ) {
          alert("Please fill all required fields correctly.");
          return;
        }

        const token = localStorage.getItem("token");
        if (!token) {
          alert("You must be logged in to publish a course.");
          return;
        }

        const formData = new FormData();
        formData.append("title", title);
        formData.append("description", description);
        formData.append("price", price);
        formData.append("class", classId);
        formData.append("image", imageFile);

        try {
          const response = await fetch("http://localhost:3000/course", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error: ${errorText}`);
          }

          const savedCourse = await response.json();
          alert("Course published successfully!");
          e.target.reset();
          document
            .getElementById("imagePreviewContainer")
            .classList.add("hidden");
        } catch (error) {
          console.error("Error publishing course:", error);
          alert("Failed to publish course.");
        }
      });
    </script>
  </body>
</html>
