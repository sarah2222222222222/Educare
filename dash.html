<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f7f8fa;
      }

      /* Floating animation */
      @keyframes float {
        0%,
        100% {
          transform: translatey(0px);
        }
        50% {
          transform: translatey(-10px);
        }
      }

      .floating {
        animation: float 2s ease-in-out infinite;
      }

      /* Card animations */
      @keyframes popIn {
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .classroom-card {
        opacity: 0;
        transform: scale(0.9);
        animation: popIn 0.4s forwards;
      }

      .classroom-card:hover {
        box-shadow: 0 8px 20px rgba(13, 140, 240, 0.4);
        transform: scale(1.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        z-index: 10;
      }

      /* Alert styles */
      .alert {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 4px;
        color: white;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
      .alert.error {
        background-color: #f44336;
      }
      .alert.success {
        background-color: #4caf50;
      }
      .alert.info {
        background-color: #2196f3;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    </style>
  </head>
  <body class="bg-[#f7f8fa] min-h-screen p-4">
    <!-- Dashboard UI -->
    <div class="max-w-[1400px] mx-auto">
      <!-- Header -->
      <header
        class="flex flex-col sm:flex-row items-center justify-between px-6 py-4 mb-6 bg-white rounded-xl shadow-sm"
      >
        <div
          class="flex items-center space-x-4 w-full sm:w-auto justify-between sm:justify-start"
        >
          <div class="flex items-center space-x-3">
            <img
              src="https://via.placeholder.com/40"
              alt="Logo"
              class="w-10 h-10 rounded-lg"
            />
            <span class="font-semibold text-gray-800 hidden sm:block"
              >EduConnect</span
            >
          </div>

          <div class="relative flex-1 max-w-md mx-4">
            <input
              type="search"
              placeholder="Search classrooms..."
              class="w-full rounded-lg border border-gray-200 bg-gray-50 py-2 px-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
          </div>
        </div>

        <div class="flex items-center space-x-4 mt-4 sm:mt-0">
          <div class="relative group">
            <i
              class="fas fa-bell text-gray-600 text-xl cursor-pointer hover:text-blue-600"
            ></i>
            <span
              class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center"
              >3</span
            >
          </div>

          <div class="flex items-center space-x-3">
            <div
              id="profile-pic"
              class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-800 font-semibold cursor-pointer"
            ></div>
            <div class="hidden sm:block">
              <p
                id="profile-name"
                class="font-medium text-gray-800 text-sm"
              ></p>
              <p
                id="profile-email"
                class="text-xs text-gray-500 truncate max-w-[160px]"
              ></p>
            </div>
            <button
              id="logout-btn"
              class="p-2 rounded-full hover:bg-gray-100 transition-colors"
              title="Logout"
            >
              <i class="fas fa-sign-out-alt text-gray-600"></i>
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="flex flex-col lg:flex-row gap-6">
        <!-- Sidebar -->
        <nav
          class="bg-white rounded-xl shadow-sm p-4 lg:p-6 w-full lg:w-64 flex-shrink-0"
        >
          <ul class="space-y-4">
            <li>
              <a
                href="#"
                class="flex items-center space-x-3 text-blue-600 font-medium"
              >
                <i class="fas fa-home text-lg"></i>
                <span>Dashboard</span>
              </a>
            </li>
            <li>
              <a
                href="#"
                class="flex items-center space-x-3 text-gray-600 hover:text-blue-600 transition-colors"
              >
                <i class="fas fa-chalkboard-teacher"></i>
                <span>Classrooms</span>
              </a>
            </li>
            <li>
              <a
                href="#"
                class="flex items-center space-x-3 text-gray-600 hover:text-blue-600 transition-colors"
              >
                <i class="fas fa-star"></i>
                <span>Favorites</span>
              </a>
            </li>
            <li>
              <a
                href="#"
                class="flex items-center space-x-3 text-gray-600 hover:text-blue-600 transition-colors"
              >
                <i class="fas fa-archive"></i>
                <span>Archived</span>
              </a>
            </li>
            <li>
              <a
                href="#"
                class="flex items-center space-x-3 text-gray-600 hover:text-blue-600 transition-colors"
              >
                <i class="fas fa-calendar-alt"></i>
                <span>Calendar</span>
              </a>
            </li>
            <li>
              <a
                href="#"
                class="flex items-center space-x-3 text-gray-600 hover:text-blue-600 transition-colors"
              >
                <i class="fas fa-cog"></i>
                <span>Settings</span>
              </a>
            </li>
            <li id="create-course-li">
              <a
                href="store.html"
                class="flex items-center space-x-3 text-gray-600 hover:text-blue-600 transition-colors"
              >
                <i class="fas fa-plus"></i>
                <span>Create Course</span>
              </a>
            </li>
          </ul>

          <div class="mt-8 pt-4 border-t border-gray-200">
            <h3
              class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3"
            >
              Quick Actions
            </h3>
            <div class="space-y-2">
              <button
                id="create-btn"
                class="w-full flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors"
              >
                <i class="fas fa-plus"></i>
                <span>Create Classroom</span>
              </button>
            </div>
          </div>
        </nav>

        <!-- Classroom Content -->
        <section class="flex-1 bg-white rounded-xl shadow-sm p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-800">My Classrooms</h2>
            <div class="flex space-x-2">
              <button class="p-2 rounded-lg hover:bg-gray-100">
                <i class="fas fa-th-large text-gray-600"></i>
              </button>
              <button class="p-2 rounded-lg hover:bg-gray-100">
                <i class="fas fa-list text-gray-600"></i>
              </button>
            </div>
          </div>
          <div class="flex justify-end mb-4">
            <a
              href="course-view.html"
              class="inline-flex items-center space-x-2 px-5 py-2.5 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition"
            >
              <i class="fas fa-book-open"></i>
              <span>View All Courses</span>
            </a>
          </div>
          <div
            id="classrooms-container"
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
          >
            <!-- Classrooms will be loaded here -->
          </div>

          <div
            id="empty-state"
            class="hidden flex flex-col items-center justify-center py-12 text-center"
          >
            <img
              src="https://via.placeholder.com/200"
              alt="No classrooms"
              class="w-40 h-40 mb-4 opacity-50"
            />
            <h3 class="text-lg font-medium text-gray-500 mb-2">
              No Classrooms Yet
            </h3>
            <p class="text-gray-400 mb-4">
              Create or join a classroom to get started
            </p>
            <div class="flex space-x-3">
              <button
                id="create-btn-2"
                class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors"
              >
                Create Classroom
              </button>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Floating AI Assistant -->
    <div class="fixed bottom-6 right-6 floating">
      <button
        class="w-16 h-16 rounded-full bg-blue-600 text-white shadow-lg hover:bg-blue-700 transition-colors flex items-center justify-center"
      >
        <i class="fas fa-robot text-2xl"></i>
      </button>
    </div>

    <!-- Authentication Check Script -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }

        // Load user data
        const userData = {
          firstName: localStorage.getItem("firstName"),
          lastName: localStorage.getItem("lastName"),
          email: localStorage.getItem("email"),
          role: localStorage.getItem("role"),
          userId: localStorage.getItem("userId"),
        };

        // Update profile section
        const profileName = document.getElementById("profile-name");
        const profileEmail = document.getElementById("profile-email");
        const profilePic = document.getElementById("profile-pic");

        if (profileName && userData.firstName) {
          profileName.textContent = `${userData.firstName} ${
            userData.lastName || ""
          }`.trim();
        }

        if (profileEmail && userData.email) {
          profileEmail.textContent = userData.email;
          profileEmail.title = userData.email;
        }

        // Set profile picture placeholder with initials
        if (profilePic && userData.firstName) {
          const initials =
            userData.firstName.charAt(0) +
            (userData.lastName ? userData.lastName.charAt(0) : "");
          profilePic.textContent = initials;
          profilePic.style.backgroundColor = getRandomColor();
        }

        // Role-based UI adjustments
        if (userData.role === "teacher") {
          document.getElementById("create-btn").classList.remove("hidden");
          document.getElementById("create-btn-2").classList.remove("hidden");
          document
            .getElementById("create-course-li")
            .classList.remove("hidden");
        } else {
          document.getElementById("create-btn").classList.add("hidden");
          document.getElementById("create-btn-2").classList.add("hidden");
          document.getElementById("create-course-li").classList.add("hidden");
        }

        // Setup logout
        document
          .getElementById("logout-btn")
          .addEventListener("click", function () {
            localStorage.clear();
            window.location.href = "login.html";
          });

        // Load classrooms
        loadClassrooms(userData.userId);
      });

      function getRandomColor() {
        const colors = [
          "#FFB6C1",
          "#FFD700",
          "#98FB98",
          "#87CEFA",
          "#DDA0DD",
          "#FFA07A",
          "#20B2AA",
          "#778899",
          "#FF6347",
          "#9370DB",
        ];
        return colors[Math.floor(Math.random() * colors.length)];
      }

      async function loadClassrooms(userId) {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch("http://localhost:3000/class", {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (!result.data || !Array.isArray(result.data)) {
            throw new Error("Invalid data format from API");
          }

          // Transform API data to match our frontend structure
          const classrooms = result.data.map((classroom) => ({
            id: classroom._id,
            name: classroom.name,
            description: `${classroom.subject} - Room ${classroom.room}`,
            subject: classroom.subject,
            code: classroom.section,
            image: getSubjectImage(classroom.subject),
            allowedUsers: classroom.allowedUsers || [], // Include allowedUsers array
            creator: classroom.creator, // Include creator ID
          }));

          renderClassrooms(classrooms, userId);
        } catch (error) {
          console.error("Error loading classrooms:", error);
          showAlert("Failed to load classrooms. Please try again.", "error");
        }
      }

      // Helper function to get appropriate subject image
      function getSubjectImage(subject) {
        const subjectImages = {
          math: "https://source.unsplash.com/random/400x240/?math",
          science: "https://source.unsplash.com/random/400x240/?science",
          literature: "https://source.unsplash.com/random/400x240/?books",
          history: "https://source.unsplash.com/random/400x240/?history",
          art: "https://source.unsplash.com/random/400x240/?art",
          music: "https://source.unsplash.com/random/400x240/?music",
          physics: "https://source.unsplash.com/random/400x240/?physics",
          chemistry: "https://source.unsplash.com/random/400x240/?chemistry",
          biology: "https://source.unsplash.com/random/400x240/?biology",
        };

        const lowerSubject = subject.toLowerCase();
        return (
          subjectImages[lowerSubject] ||
          "https://source.unsplash.com/random/400x240/?classroom"
        );
      }

      function renderClassrooms(classrooms, userId) {
        const container = document.getElementById("classrooms-container");
        const emptyState = document.getElementById("empty-state");

        if (!classrooms || classrooms.length === 0) {
          emptyState.classList.remove("hidden");
          return;
        }

        emptyState.classList.add("hidden");
        container.innerHTML = "";

        classrooms.forEach((classroom, index) => {
          const card = document.createElement("div");
          card.className = `bg-white rounded-xl p-4 shadow-md hover:shadow-lg transition-all duration-300 classroom-card`;
          card.style.animationDelay = `${index * 0.1}s`;

          card.innerHTML = `
          <div class="relative h-40 rounded-lg overflow-hidden mb-3">
            <img src="${classroom.image}" alt="${classroom.name}" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
            <span class="absolute bottom-2 left-2 text-white font-semibold text-sm">${classroom.subject}</span>
          </div>
          <h3 class="font-semibold text-lg text-gray-800 truncate">${classroom.name}</h3>
          <p class="text-sm text-gray-600 mt-1 line-clamp-2">${classroom.description}</p>
          <div class="mt-3 flex justify-between items-center">
            <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded">${classroom.code}</span>
            <div class="flex space-x-2">
              <button class="join-classroom-btn text-blue-600 hover:text-blue-800 transition-colors" data-code="${classroom.code}" data-id="${classroom.id}">
                <i class="fas fa-user-plus"></i>
              </button>
              <button class="enter-classroom-btn text-blue-600 hover:text-blue-800 transition-colors" data-id="${classroom.id}">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        `;

          container.appendChild(card);
        });

        // Add event listeners to all join buttons
        document.querySelectorAll(".join-classroom-btn").forEach((button) => {
          button.addEventListener("click", async function () {
            const classCode = this.getAttribute("data-code");
            const classId = this.getAttribute("data-id");

            try {
              const token = localStorage.getItem("token");
              const userId = localStorage.getItem("userId");

              // First, get the classroom details to check allowedUsers
              const response = await fetch(
                `http://localhost:3000/class/${classId}`,
                {
                  headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                  },
                }
              );

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const classroom = await response.json();

              if (!classroom.data) {
                throw new Error("Classroom not found");
              }

              // Check if user is allowed to join
              const isAllowed =
                classroom.data.allowedUsers.includes(userId) ||
                classroom.data.creator === userId;

              if (!isAllowed) {
                showAlert("You don't have access to this classroom", "error");
                return;
              }

              // If allowed, proceed to join
              showAlert(`Joining classroom with code: ${classCode}`, "info");
              window.location.href = `stream.html?classId=${classId}`;
            } catch (error) {
              console.error("Error joining classroom:", error);
              showAlert("Failed to join classroom. Please try again.", "error");
            }
          });
        });

        // Add event listeners to all enter buttons
        document.querySelectorAll(".enter-classroom-btn").forEach((button) => {
          button.addEventListener("click", async function () {
            const classId = this.getAttribute("data-id");

            try {
              const token = localStorage.getItem("token");
              const userId = localStorage.getItem("userId");

              // First, get the classroom details to check allowedUsers
              const response = await fetch(
                `http://localhost:3000/class/${classId}`,
                {
                  headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                  },
                }
              );

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const classroom = await response.json();

              if (!classroom.data) {
                throw new Error("Classroom not found");
              }

              // Check if user is allowed to enter
              const isAllowed =
                classroom.data.allowedUsers.includes(userId) ||
                classroom.data.creator === userId;

              if (!isAllowed) {
                showAlert("You don't have access to this classroom", "error");
                return;
              }

              // If allowed, proceed to enter
              showAlert(`Entering classroom`, "info");
              window.location.href = `stream.html?classId=${classId}`;
            } catch (error) {
              console.error("Error entering classroom:", error);
              showAlert(
                "Failed to enter classroom. Please try again.",
                "error"
              );
            }
          });
        });
      }

      function showAlert(message, type = "info") {
        const alert = document.createElement("div");
        alert.className = `alert ${type}`;
        alert.textContent = message;
        document.body.appendChild(alert);

        setTimeout(() => {
          alert.remove();
        }, 5000);
      }
    </script>
  </body>
</html>
